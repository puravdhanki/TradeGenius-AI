<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - TradeGenius AI</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .admin-container {
            padding: var(--spacing-2xl) 0;
            min-height: 100vh;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        .stat-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-tertiary));
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-md);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-value {
            font-size: 2.5rem;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
        }
        .stat-label {
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 39, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .login-modal.hidden {
            display: none;
        }
        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-2xl);
            max-width: 400px;
            width: 100%;
            box-shadow: var(--shadow-lg);
        }
        .login-title {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            font-size: 1.8rem;
        }
        .admin-content {
            display: none;
        }
        .admin-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand">
                <span class="logo-icon">ðŸ“Š</span>
                <span class="logo-text">TradeGenius AI</span>
            </a>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="navbar-menu" id="navbarMenu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="charts.html" class="nav-link">Live Charts</a></li>
                <li><a href="ai-assistant.html" class="nav-link">AI Assistant</a></li>
                <li><a href="admin.html" class="nav-link active">Admin</a></li>
            </ul>
        </div>
    </nav>

    <div class="login-modal" id="loginModal">
        <div class="login-card">
            <h2 class="login-title">
                <i class="fas fa-shield-alt"></i> Admin Login
            </h2>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-input" value="admin" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-input" value="admin123" required>
                </div>
                <div class="form-group">
                    <label class="form-label">API Endpoint</label>
                    <input type="text" id="adminApiEndpoint" class="form-input" value="http://localhost:3000/api/admin/analytics" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>
    </div>

    <div class="admin-container admin-content" id="adminContent">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xl); flex-wrap: wrap; gap: var(--spacing-md);">
                <div>
                    <h1>
                        <i class="fas fa-cog"></i> Admin Dashboard
                    </h1>
                    <p class="text-secondary" style="margin-top: var(--spacing-sm);">
                        Analytics and system monitoring
                    </p>
                </div>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-value" id="totalAnalyses">0</div>
                    <div class="stat-label">Total Analyses</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-value" id="successfulTrades">0</div>
                    <div class="stat-label">Successful</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-value" id="failedTrades">0</div>
                    <div class="stat-label">Failed</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: var(--spacing-md);">
                    <i class="fas fa-info-circle"></i> Admin Panel Information
                </h3>
                <p class="text-secondary">
                    This admin panel displays analytics data from the backend API. 
                    Make sure the backend server is running and configured properly.
                </p>
                <p class="text-secondary" style="margin-top: var(--spacing-md);">
                    Default credentials: <code>admin / admin123</code>
                </p>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/config.js"></script>
    <script>
        let authCredentials = null;
        
        // Show loading state
        function showAdminLoading() {
            const loginBtn = document.querySelector('#loginModal button[type="submit"]');
            if (loginBtn) {
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                loginBtn.disabled = true;
            }
        }
        
        // Hide loading state
        function hideAdminLoading() {
            const loginBtn = document.querySelector('#loginModal button[type="submit"]');
            if (loginBtn) {
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
                loginBtn.disabled = false;
            }
        }

        function login(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const apiEndpoint = document.getElementById('adminApiEndpoint').value.trim();
            
            if (!username || !password || !apiEndpoint) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            authCredentials = { username, password, apiEndpoint };
            Storage.set('adminApiEndpoint', apiEndpoint);
            
            showAdminLoading();
            fetchAnalytics();
        }

        function logout() {
            authCredentials = null;
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('adminContent').classList.remove('active');
            showToast('Logged out successfully', 'info');
        }

        async function fetchAnalytics() {
            if (!authCredentials) {
                showToast('Authentication credentials not found', 'error');
                hideAdminLoading();
                return;
            }

            try {
                // Add timeout to prevent hanging requests
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(authCredentials.apiEndpoint, {
                    signal: controller.signal,
                    headers: {
                        'username': authCredentials.username,
                        'password': authCredentials.password,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);

                if (response.status === 401 || response.status === 403) {
                    throw new Error('Invalid credentials: Access denied');
                }

                if (response.status === 404) {
                    throw new Error('API endpoint not found. Check the URL path');
                }

                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('adminContent').classList.add('active');
                    displayStats(result.data);
                    showToast('Login successful! Analytics loaded.', 'success');
                    
                    // Refresh stats every 30 seconds
                    setTimeout(fetchAnalytics, 30000);
                } else {
                    throw new Error(result.error || 'Failed to fetch analytics data');
                }
            } catch (error) {
                console.error('Error fetching analytics:', error);
                
                let errorMessage = error.message;
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timeout: Server took too long to respond';
                } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage = 'Network error: Cannot connect to server. Check if server is running and CORS is enabled';
                }
                
                showToast(`Error: ${errorMessage}`, 'error');
                
                // Detailed error message in alert
                alert(`Error: ${errorMessage}\n\nTroubleshooting steps:\n
1. Ensure backend server is running (check terminal/command prompt)
2. Verify API endpoint URL: ${authCredentials?.apiEndpoint || 'Not set'}
3. Check CORS configuration on backend
4. Verify username/password in backend configuration
5. Check backend server logs for errors
6. Ensure port 3000 is not blocked by firewall

Common issues:
- Backend server not started: Run "npm start" in backend folder
- Wrong API endpoint: Should be "http://localhost:3000/api/admin/analytics"
- CORS error: Check backend CORS configuration
- Invalid credentials: Default is admin/admin123`);
            } finally {
                hideAdminLoading();
            }
        }

        function displayStats(data) {
            // Safely update stats with null checks
            const totalAnalyses = data?.totalAnalyses || 0;
            const successfulTrades = data?.successfulTrades || 0;
            const failedTrades = data?.failedTrades || 0;
            
            document.getElementById('totalAnalyses').textContent = totalAnalyses;
            document.getElementById('successfulTrades').textContent = successfulTrades;
            document.getElementById('failedTrades').textContent = failedTrades;

            const successRate = totalAnalyses > 0 
                ? ((successfulTrades / totalAnalyses) * 100).toFixed(1)
                : '0';
            document.getElementById('successRate').textContent = successRate + '%';
            
            // Update last refresh time
            updateLastRefreshTime();
        }
        
        function updateLastRefreshTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const dateString = now.toLocaleDateString('en-IN');
            
            // Create or update refresh time display
            let refreshElement = document.getElementById('lastRefreshTime');
            if (!refreshElement) {
                refreshElement = document.createElement('div');
                refreshElement.id = 'lastRefreshTime';
                refreshElement.className = 'text-secondary';
                refreshElement.style.fontSize = '0.85rem';
                refreshElement.style.marginTop = 'var(--spacing-md)';
                refreshElement.style.textAlign = 'center';
                document.querySelector('.admin-container .container').appendChild(refreshElement);
            }
            refreshElement.textContent = `Last refreshed: ${dateString} ${timeString}`;
        }

        // Load saved endpoint on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedEndpoint = Storage.get('adminApiEndpoint');
            if (savedEndpoint) {
                document.getElementById('adminApiEndpoint').value = savedEndpoint;
            }
            
            // Check if already logged in
            const savedCredentials = Storage.get('adminCredentials');
            if (savedCredentials) {
                authCredentials = savedCredentials;
                fetchAnalytics();
            }
            
            // Auto-focus username field
            document.getElementById('username').focus();
            
            // Add enter key support
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.querySelector('#loginModal form').dispatchEvent(new Event('submit'));
                }
            });
        });
    </script>
</body>
</html>